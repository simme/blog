<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>I Am Simme</title>
      <link href="https://fonts.googleapis.com/css?family=Oswald:600&amp;subset=latin-ext" rel="stylesheet">
      <link href="https://iamsim.me/css/master.css" rel="stylesheet">
      <link href="https://iamsim.me/index.xml" rel="alternate" type="application/rss+xml" title="" />
      <link href="https://iamsim.me/index.xml" rel="feed" type="application/rss+xml" title="" />
      <link href="" rel="alternate" type="application/json" title="" />
   </head>
   <body>
      <header class="page-header">
         
            <a href="https://iamsim.me/" class="page-header-logo">I Am Simme</a>
         
         <p>
            A blog about programming, photography and other things I like and don't.
         </p>
      </header>

      <section class="main">


    <article class="post">
      <span class="date">July 19, 2016</span>
      <h1>The Coordinator Pattern</h1>
      <div class="content">
         

<p>Soroush Khanlou had a very interesting <a href="http://khanlou.com/2015/10/coordinators-redux/">blog post</a> a while back. In it he elaborates on his &ldquo;coordinator pattern&rdquo;. Its a very neat pattern in which you make all of your view controllers &ldquo;flow agnostic&rdquo;. Ie. they know nothing about the view controller hierarchy, when to push another view controller on the navigation stack, when to present a modal etc. All of that responsibility is delegated to a coordinator object. Each view controller becomes completely isolated. If you haven&rsquo;t read his post you should go ahead and do that before continuing here. It&rsquo;s a great read!</p>

<p>I&rsquo;m currently working on a new app for <a href="http://filibaba.com">Filibaba</a>. When the various flows of the app started coming together I quickly realized that many of the view controllers were basically the same, but with small variations in behavior. I had started building the app using storyboards and segues and that was quickly becoming a mess.</p>

<h2 id="isolation">Isolation</h2>

<p>I took a week to pause feature development and rewrite each view controller. Instead of having direct access to the model layer each view controller now has properties and a delegate that informs the behavior. Instead of pushing a detail view controller on the stack a table view instead notifies its delegate (most likely a coordinator) that a cell was selected. The delegate then creates the detail view controller and pushes it on the stack.</p>

<p>This means that no view controller relies on global state or is in any other way tied to the rest of the environment. So reusing them becomes incredibly easy.</p>

<h2 id="enter-coordinator">Enter Coordinator</h2>

<p>After doing this I was left with very pretty view controllers, but a very broken app. So I took to pen and paper to sketch out each of the flows in the app. Basically a flow chart of the entire app. Doing this I could identify areas where the same type of flow occurred. Each of these areas became their own coordinator.</p>

<p>For example, I had a onboarding flow that was very similar to the edit flow. These became the one and same coordinator.</p>

<p>After having each of the flows down I started thinking about what a coordinator needed to be able to do:</p>

<ul>
<li>Maintain a list of child coordinators.</li>
<li>They need a root view controller to start from.</li>
<li>They need a reference to my storyboard to instantiate view controllers.</li>
<li>They need a reference to my &ldquo;application context&rdquo; (an object containing database connections and settings).</li>
<li>Start and stop child coordinators.</li>
</ul>

<p>I came up with this protocol (gist, might not show up in RSS readers):</p>

<script src="https://gist.github.com/simme/ea0918d534f13ace3445e84ec043ed99.js"></script>

<p>(To simplify things pertaining to storing of child coordinators etc I made the coordinators <code>NSObject</code>s. Generic self constraints and what not. Would be great to get around this somehow.)</p>

<p>The default implementation extension provides convenience methods for starting and stopping a coordinator.</p>

<h2 id="usage">Usage</h2>

<p>So imagine you have a view controller showing a contact. The view is displaying an edit button. The view controller is managed by a <code>ContactsBrowsingCoordinator</code>. The user taps that edit button which triggers a delegate call: <code>delegate?.contactDetailViewController(contactDetailViewController: ContactDetailViewController, wantsToEditContact contact: Contact)</code></p>

<p>The delegate of the view controller is the <code>ContactsBrowsingCoordinator</code>. When the <code>wantsToEdit</code> method is called it spins off a <code>EditContactCoordinator</code> doing something like this:</p>

<pre><code>func contactDetailViewController(contactDetailViewController: ContactDetailViewController, wantsToEditContact contact: Contact) {
  // The type of coordinator to start is inferred by the type declaration in the block.
  startChildWith(rootViewController, callback: nil) { (coordinator: EditContactCoordinator) in
		// Your chance to set behavioral properties on the `EditContactCoordinator`, like the contact being edited.
		// This block is called _before_ the start method of the coordinator.
		coordinator.contactToEdit = contact
		
		// This coordinator can be a delegate of the new coordinator to get notified of events. Like when the user is done. This is when this coordinator would call `stop` on the edit coordinator which would then rewind the navigation stack and return to where it kicked off.
		coordinator.delegate = self
  }
}
</code></pre>

<p>In the <code>start</code> method of the <code>EditContactCoordinator</code> we create the edit view controller and present it:</p>

<pre><code>func start(withCallback: CoordinatorCallback) {
  // See: https://medium.com/swift-programming/uistoryboard-safer-with-enums-protocol-extensions-and-generics-7aad3883b44d
  let viewController: EditContactViewController = storyboard.instantiateViewController()
  
  // Pass on the property we set before
  viewController.contact = contact
  viewController.delegate = self
  
  rootViewController.presentViewController(viewController, animated: true)
}
</code></pre>

<h2 id="recap">Recap</h2>

<p>This particular design has made it super simple for me to modify the various flows when we&rsquo;ve made changes to ordering. It makes each view controller very simple and easy to read and reason about.</p>

<p>All of the flows are clearly articulated in each coordinator and following along is straight forward. I don&rsquo;t think I&rsquo;ll ever write an app any other way.</p>

<p>Sure, it&rsquo;s a bit of boilerplate. For smaller apps you will end up with more code just to connect two view controllers. But I still think it&rsquo;s worth it in the long run. It also helps you think about what each view controller has to be able to do when you define its delegate protocol. It is easy to see when things start to get out of hand and you might have to split things up further.</p>

<p>I implement each view controller delegate as an extension to my coordinators. This way it is easy to split it up into multiple files and find the bit of code you&rsquo;re looking for.</p>

<p>Many, not all, view controllers are still defined and laid out in a storyboard. I&rsquo;m just not using segues. Instead I&rsquo;m using a <a href="https://medium.com/swift-programming/uistoryboard-safer-with-enums-protocol-extensions-and-generics-7aad3883b44d">storyboard extension</a> to make view controller instantiation super simple.</p>

<p>I&rsquo;d be happy to answer any questions on Twitter: <a href="https://twitter.com/simmelj">@simmelj</a>. Or in the comments of the gist. If you have any other feedback on how one might improve the Coordinator protocol I&rsquo;d be super happy, still very new to generics.</p>

      </div>
    </article>
      </section>

      <footer class="page-footer">
         <p>
            All content and code on this site is provided under the MIT license.
         </p>
         <nav>
            <ol>
               <li><a href="https://twitter.com/simmelj">@simmelj</a></li>
               <li><a href="https://github.com/simme">GitHub</a></li>
            </ol>
         </nav>
      </footer>
   </body>
</html>

